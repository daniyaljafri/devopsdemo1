name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Download artifact
      uses: actions/github-script@v7
      with:
        script: |
          let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
             owner: context.repo.owner,
             repo: context.repo.repo,
             run_id: context.payload.workflow_run.id,
          });
          let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
            return artifact.name == "website-files"
          })[0];
          let download = await github.rest.actions.downloadArtifact({
             owner: context.repo.owner,
             repo: context.repo.repo,
             artifact_id: matchArtifact.id,
             archive_format: 'zip',
          });
          let fs = require('fs');
          fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/website.zip`, Buffer.from(download.data));
    
    - name: Extract and deploy
      shell: powershell
      run: |
        # Clean and create deployment directory
        Remove-Item -Path "C:\deploy\website" -Recurse -Force -ErrorAction SilentlyContinue
        New-Item -ItemType Directory -Force -Path "C:\deploy\website"
        
        # Extract files
        Expand-Archive -Path "website.zip" -DestinationPath "C:\deploy\website" -Force
        
        # Navigate to app directory (handle if files are in subdirectory)
        if (Test-Path "C:\deploy\website\package.json") {
          Set-Location "C:\deploy\website"
        } else {
          $appDir = Get-ChildItem "C:\deploy\website" -Directory | Select-Object -First 1
          Set-Location $appDir.FullName
        }
        
        # Install dependencies
        npm install
    
    - name: Start app with PM2
      shell: powershell
      run: |
        # Stop existing app (ignore errors)
        pm2 delete hello-world -s 2>$null
        
        # Navigate to app directory
        if (Test-Path "C:\deploy\website\package.json") {
          Set-Location "C:\deploy\website"
        } else {
          $appDir = Get-ChildItem "C:\deploy\website" -Directory | Select-Object -First 1
          Set-Location $appDir.FullName
        }
        
        # Start new app
        pm2 start index.js --name hello-world
        pm2 save
        
        # Quick health check
        Start-Sleep -Seconds 5
        try {
          Invoke-WebRequest -Uri "http://localhost:3000" -UseBasicParsing -TimeoutSec 10
          Write-Host "✅ App deployed successfully at http://localhost:3000"
        } catch {
          Write-Host "⚠️ App started but may need more time to be ready"
          pm2 status
        }