name: CD Pipeline
on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Download artifact
      uses: actions/github-script@v7
      with:
        script: |
          let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
             owner: context.repo.owner,
             repo: context.repo.repo,
             run_id: context.payload.workflow_run.id,
          });
          let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
            return artifact.name == "website-files"
          })[0];
          let download = await github.rest.actions.downloadArtifact({
             owner: context.repo.owner,
             repo: context.repo.repo,
             artifact_id: matchArtifact.id,
             archive_format: 'zip',
          });
          let fs = require('fs');
          fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/website.zip`, Buffer.from(download.data));
    
    - name: Extract files
      run: |
        echo "Extracting files..."
        mkdir -p /home/hp/website
        unzip -o website.zip -d /home/hp/website/
        echo "Files extracted to /home/hp/website/!"
        ls -la /home/hp/website/
    
    - name: Set up Node.js if not installed
      run: |
        if ! command -v node &> /dev/null; then
          echo "Installing Node.js..."
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
        fi
        node --version
    
    - name: Install dependencies
      working-directory: /home/hp/website
      run: npm install
    
    - name: Verify PM2
      run: |
        if ! command -v pm2 &> /dev/null; then
          echo "PM2 not found! Exiting..."
          exit 1
        fi
        pm2 --version
    
    - name: Stop existing server
      working-directory: /home/hp/website
      run: |
        echo "Stopping any existing PM2 app..."
        pm2 delete hello-world || echo "No existing PM2 app found"
        if lsof -ti:3000 >/dev/null 2>&1; then
          echo "Killing processes on port 3000..."
          sudo kill -9 $(lsof -ti:3000) || echo "Could not kill processes on port 3000"
        fi
    
    - name: Start Node.js app with PM2
      working-directory: /home/hp/website
      run: |
        echo "Starting app with PM2..."
        pm2 start index.js --name hello-world
        pm2 save
        sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u hp
        echo "App started with PM2!"
    
    - name: Verify server is accessible
      run: |
        echo "Testing server accessibility..."
        sleep 5
        for i in {1..10}; do
          if curl -s http://localhost:3000 >/dev/null 2>&1; then
            echo "Server responds on localhost:3000"
            break
          else
            echo "Attempt $i: Server not ready, waiting..."
            sleep 2
          fi
        done
        if curl -s http://172.26.60.61:3000 >/dev/null 2>&1; then
          echo "âœ… Website is live at http://172.26.60.61:3000"
        else
          echo "âŒ Server not responding externally"
          pm2 logs hello-world --lines 20
          pm2 status
          exit 1
        fi
        echo "ğŸ‰ Deployment complete! Website running persistently with PM2."
        echo "ğŸŒ Access your website at: http://172.26.60.61:3000"
