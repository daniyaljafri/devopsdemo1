name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: website-files
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}
    
    - name: Deploy app
      shell: powershell
      run: |
        # Clean deployment directory
        $deployPath = "C:\deploy\website"
        Remove-Item -Path $deployPath -Recurse -Force -ErrorAction SilentlyContinue
        New-Item -ItemType Directory -Force -Path $deployPath
        
        # Extract files
        Write-Host "Extracting website.zip..."
        Expand-Archive -Path "website.zip" -DestinationPath $deployPath -Force
        
        # Find app directory (handle nested extraction)
        $packageJson = Get-ChildItem -Path $deployPath -Filter "package.json" -Recurse -File | Select-Object -First 1
        if ($packageJson) {
          $appDir = $packageJson.DirectoryName
          Set-Location $appDir
          Write-Host "Using app directory: $appDir"
        } else {
          Write-Host "❌ package.json not found"
          exit 1
        }
        
        # Install dependencies and start app
        npm install
        pm2 delete hello-world -s 2>$null
        pm2 start index.js --name hello-world
        pm2 save
        
        # Verify deployment
        Start-Sleep -Seconds 5
        try {
          Invoke-WebRequest -Uri "http://localhost:3000" -UseBasicParsing -TimeoutSec 10
          Write-Host "✅ App deployed successfully at http://localhost:3000"
        } catch {
          Write-Host "⚠️ App started but may need more time"
          pm2 status
        }